pipline{
    agent any
    stages{
        stage('deploy start'){
            // 배포 작업 이전에 배포 시작 알림 메시지를 슬랙 채널로 전송
            // 자격증명을 젠키스에서 구성한 slack-key로 사용
            steps{
                slackSend(message: "Deploy ${env.BUILD_NUMBER} Started", color: 'good', tokenCredentialId: 'slack-key')
            }
        }
        // 깃허브 저장소에서 야믈 파일 받기
        stage('git pull'){
            steps{
                git url: 'https://github.com/akm4545/k8s-GitOps-study.git', branch: 'main'
            }
        }
        // 미리 설정한 kubeconfig 자격 증명을 이용해 현재 내려받은 경로에 존재하는 야믈 파일들의 내용을
        // 쿠버네티스 클러스터에 배포
        stage('k8s deploy'){
            steps{
                kubernetesDeploy(kubeconfigId: 'kubeconfig', configs: '*.yaml')
            }
        }
        stage('deploy end'){
            // 배포 이후 배포 완료 메시지 슬랙 채널로 전송
            steps{
                slackSend(message: """${env.JOB_NAME} #${env.BUILD_NUMBER} End""", color: 'good', tokenCredentialId: 'slack-key')
            }
        }
    }
}